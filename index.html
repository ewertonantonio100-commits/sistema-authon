<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Authon (Premium)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILO GERAL --- */
        :root { 
            --primary: #c0392b; 
            --primary-grad: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --dark: #2c3e50; --bg: #ecf0f1; --card-bg: #ffffff;
            --text-main: #2c3e50; --text-light: #7f8c8d;
            --green-grad: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --blue-grad: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            --shadow: 0 8px 30px rgba(0,0,0,0.08); --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text-main); padding-bottom: 100px; }
        
        /* TELA DE LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-logo { font-family: 'Oswald', sans-serif; font-size: 32px; color: var(--primary); margin-bottom: 10px; display: block; }
        
        /* RESTO DO ESTILO */
        .brand-header { padding: 25px 20px 10px 20px; text-align: center; }
        .brand-logo { font-family: 'Oswald', sans-serif; font-size: 26px; color: var(--dark); text-transform: uppercase; letter-spacing: 2px; border-bottom: 3px solid var(--primary); padding-bottom: 5px; }

        .container { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; margin: 15px; border: 1px solid rgba(0,0,0,0.02); animation: fadeIn 0.4s ease-out; }
        .header-title h1 { text-transform: uppercase; color: var(--primary); font-size: 18px; letter-spacing: 1px; text-align: center; margin-bottom: 20px; }

        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #dfe6e9; border-radius: 12px; background: #fdfdfd; font-family: 'Poppins', sans-serif; font-size: 15px; color: var(--dark); margin-bottom: 10px; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: #fff; }
        label { font-size: 0.85rem; font-weight: 600; color: var(--text-light); margin-bottom: 5px; display: block; }

        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 15px; color: white; text-transform: uppercase; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-add { background: var(--dark); } .btn-gen { background: var(--primary-grad); }
        
        .service-row { display: grid; grid-template-columns: 50px 1fr 75px 40px; gap: 8px; align-items: center; background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; }
        .stock-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .stock-ok { background: #dff9fb; color: #2c3e50; } .stock-low { background: #ffcccc; color: #c0392b; font-weight: bold; }
        
        .op-type-switch { display: flex; background: #dfe6e9; padding: 5px; border-radius: 14px; margin-bottom: 20px; }
        .op-btn { flex: 1; padding: 12px; border: none; background: transparent; font-weight: 600; color: #7f8c8d; cursor: pointer; border-radius: 10px; }
        .op-btn.active.venda { background: var(--green-grad); color: white; }
        .op-btn.active.orcamento { background: var(--orange-grad); color: white; }
        .op-btn.active.agendamento { background: var(--blue-grad); color: white; }

        .item-card { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); position: relative; border-left: 6px solid #ccc; margin-bottom: 15px; }
        .status-badge { position: absolute; top: 15px; right: 15px; font-size: 10px; padding: 4px 10px; border-radius: 20px; color: white; font-weight: 700; }
        .st-venda { border-left-color: #27ae60; } .bg-venda { background: #27ae60; }
        .bg-pendente { background: #f1c40f; color: #2c3e50 !important; } .st-orcamento { border-left-color: #95a5a6; } .bg-orcamento { background: #95a5a6; }
        
        .card-actions { margin-top: 15px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid #f1f2f6; padding-top: 12px; flex-wrap: wrap; }
        .btn-card { font-size: 11px; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; color: white; }

        .tab-content { display: none; animation: fadeIn 0.4s ease; padding-bottom: 20px;} .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); display: flex; padding: 10px 0 15px 0; z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; color: #95a5a6; flex: 1; cursor: pointer; display:flex; flex-direction:column; align-items:center; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        
        /* PDF Hidden */
        #pdf-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 2000; display: none; overflow-y: auto; }
        #invoice-paper { background: white; width: 210mm; min-height: 280mm; margin: 0 auto; padding: 10mm; border-left: 12px solid var(--primary); display: flex; flex-direction: column; font-family: 'Roboto', sans-serif; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <span class="login-logo">SISTEMA AUTHON</span>
            <p style="color:#7f8c8d; margin-bottom:20px;">Acesso Restrito ao Sistema</p>
            <input type="email" id="loginEmail" placeholder="Seu E-mail" style="margin-bottom:15px;">
            <input type="password" id="loginPass" placeholder="Sua Senha" style="margin-bottom:20px;">
            <button class="btn-action btn-gen" onclick="login()">ENTRAR NO SISTEMA</button>
            <p id="login-error" style="color:#c0392b; font-size:12px; margin-top:10px; display:none;"></p>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <div class="brand-header">
            <span class="brand-logo">SISTEMA AUTHON</span>
            <div style="font-size:10px; color:#999; margin-top:5px; cursor:pointer;" onclick="logout()">SAIR (LOGOUT)</div>
        </div>

        <div id="tab-new" class="tab-content active">
            <div class="container">
                <div class="header-title"><h1>Nova Operação</h1></div>
                <div class="op-type-switch">
                    <button type="button" class="op-btn active venda" onclick="setOpType('venda')">VENDA</button>
                    <button type="button" class="op-btn orcamento" onclick="setOpType('orcamento')">ORÇAMENTO</button>
                    <button type="button" class="op-btn agendamento" onclick="setOpType('agendamento')">AGENDAR</button>
                </div>
                <input type="hidden" id="opType" value="venda">
                <input type="hidden" id="editId" value=""><input type="hidden" id="firebaseDocId" value="">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Data</label><input type="date" id="date"></div>
                    <div id="div-hora" style="display:none"><label>Hora</label><input type="time" id="time"></div>
                    <div><label>Celular</label><input type="tel" id="phone" placeholder="(00) 00000-0000"></div>
                </div>
                <label>Cliente</label><input type="text" id="clientName" list="client-list" placeholder="Buscar Cliente" onchange="fillClientData(this)">
                <datalist id="client-list"></datalist>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Veículo</label><input type="text" id="vehicle" placeholder="Modelo"></div>
                    <div><label>Placa</label><input type="text" id="plate" style="text-transform:uppercase"></div>
                    <div><label>Cor</label><input type="text" id="color"></div>
                    <div><label>KM</label><input type="number" id="currentKm"></div>
                </div>

                <h3 style="margin:15px 0; font-size:16px; border-bottom:1px solid #eee;">Serviços & Peças</h3>
                <div id="services-list"></div>
                <button class="btn-action btn-add" onclick="addNewItem()" style="padding:10px; font-size:12px;">+ Adicionar Item</button>
                
                <div style="margin-top:20px; text-align:right;">
                    <label style="display:inline;">Desconto R$</label> <input type="number" id="discount" style="width:80px; text-align:right;" oninput="calcTotal()">
                    <div style="font-size:1.8rem; font-weight:700; color:var(--dark);">Total: R$ <span id="display-total">0,00</span></div>
                </div>

                <div id="payment-div">
                    <label>Pagamento</label>
                    <select id="payment" onchange="toggleFeeInput()">
                        <option value="Pix">Pix</option><option value="Dinheiro">Dinheiro</option>
                        <option value="Débito">Débito</option><option value="Crédito 1x">Crédito 1x</option>
                    </select>
                </div>
                <button class="btn-action btn-gen" onclick="saveOperation()">FINALIZAR</button>
            </div>
        </div>
        <div id="tab-agenda" class="tab-content"><div style="padding:15px;"><h1>Agenda</h1></div><div id="agenda-list" style="padding:0 15px;"></div></div>
        <div id="tab-history" class="tab-content"><div style="padding:15px;"><h1>Histórico</h1></div><div id="history-list" style="padding:0 15px;"></div></div>
        
        <div id="tab-settings" class="tab-content">
            <div class="container">
                <div class="header-title"><h1>Dados da Empresa</h1></div>
                <p style="font-size:12px; color:#666; margin-bottom:15px;">Preencha aqui. Esses dados sairão no topo de todos os orçamentos e recibos.</p>
                
                <label>Nome da Oficina / Empresa</label>
                <input type="text" id="cfgName" placeholder="Ex: Martelinho de Ouro">
                
                <label>CNPJ / CPF</label>
                <input type="text" id="cfgCnpj" placeholder="00.000.000/0001-00">
                
                <label>Endereço Completo</label>
                <input type="text" id="cfgAddr" placeholder="Rua, Número, Bairro, Cidade">
                
                <label>Telefone / WhatsApp</label>
                <input type="text" id="cfgPhone" placeholder="(00) 90000-0000">
                
                <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
                
                <label>Chave Pix (Para Recibo)</label>
                <input type="text" id="cfgPix">
                
                <label>Texto de Garantia</label>
                <textarea id="cfgWarranty" rows="3" placeholder="Ex: Garantia de 90 dias..."></textarea>
                
                <button class="btn-action btn-gen" onclick="saveSettingsCustom()">SALVAR CONFIGURAÇÕES</button>
                <button class="btn-action" style="background:#7f8c8d; margin-top:10px;" onclick="openModal()"><i class="fas fa-camera"></i> Alterar Logo</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="showTab('new', this)"><i class="fas fa-plus-circle"></i><span style="font-size:10px">Novo</span></div>
            <div class="nav-item" onclick="showTab('agenda', this)"><i class="fas fa-calendar-alt"></i><span style="font-size:10px">Agenda</span></div>
            <div class="nav-item" onclick="showTab('history', this)"><i class="fas fa-history"></i><span style="font-size:10px">Histórico</span></div>
            <div class="nav-item" onclick="showTab('settings', this)"><i class="fas fa-cog"></i><span style="font-size:10px">Config</span></div>
        </div>
    </div> 
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, where } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // SUA CHAVE DE CONEXÃO
        const firebaseConfig = {
          apiKey: "AIzaSyBGmuAFUea7Mdbf8T_6phsNV-RfyUoHJ18",
          authDomain: "sistema-authon-f7045.firebaseapp.com",
          projectId: "sistema-authon-f7045",
          storageBucket: "sistema-authon-f7045.firebasestorage.app",
          messagingSenderId: "113445333308",
          appId: "1:113445333308:web:244a00fa15e5bc63ce9639"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null; // Guarda quem está logado

        // --- AUTENTICAÇÃO E ISOLAMENTO DE DADOS ---
        window.login = function() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const errDiv = document.getElementById('login-error');
            
            signInWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    errDiv.style.display = 'none';
                })
                .catch((error) => {
                    errDiv.style.display = 'block';
                    errDiv.innerText = "Erro: Email ou senha incorretos.";
                });
        }

        window.logout = function() { signOut(auth); location.reload(); }

        // MONITOR DE LOGIN (O GUARDIÃO)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // USUÁRIO LOGADO: Carrega SÓ os dados dele (Filtro por UID)
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                
                const q = query(collection(db, "operacoes"), where("uid", "==", user.uid));
                
                onSnapshot(q, (snapshot) => {
                    const dbLocal = [];
                    snapshot.forEach((doc) => {
                        dbLocal.push({ ...doc.data(), docId: doc.id });
                    });
                    dbLocal.sort((a,b) => b.id - a.id);
                    localStorage.setItem('oficina_db_master', JSON.stringify(dbLocal));
                    if(window.renderHistory) window.renderHistory('all');
                    if(window.renderAgenda) window.renderAgenda();
                });
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });

        // --- FUNÇÕES FIREBASE SEGURAS ---
        window.saveToCloud = async function(data) {
            if(!currentUser) return alert("Erro: Não logado!");
            data.uid = currentUser.uid; // IMPORTANTE: Carimba o dono do dado
            try { await addDoc(collection(db, "operacoes"), data); return true; } 
            catch(e) { console.error(e); alert("Erro ao salvar!"); return false; }
        }
        
        window.updateInCloud = async function(docId, data) {
            try { await updateDoc(doc(db, "operacoes", docId), data); } catch(e) { console.error(e); }
        }
        window.deleteFromCloud = async function(docId) {
             try { await deleteDoc(doc(db, "operacoes", docId)); } catch(e) { console.error(e); }
        }
    </script>
    <script>
        // CONFIGURAÇÕES INICIAIS
        window.onload = function() {
            const date = new Date(); document.getElementById('date').value = date.toISOString().split('T')[0];
            
            // Carrega Configurações Salvas (Preenche os inputs se já tiver dados)
            if(localStorage.getItem('authon_cfg_name')) document.getElementById('cfgName').value = localStorage.getItem('authon_cfg_name');
            if(localStorage.getItem('authon_cfg_cnpj')) document.getElementById('cfgCnpj').value = localStorage.getItem('authon_cfg_cnpj');
            if(localStorage.getItem('authon_cfg_addr')) document.getElementById('cfgAddr').value = localStorage.getItem('authon_cfg_addr');
            if(localStorage.getItem('authon_cfg_phone')) document.getElementById('cfgPhone').value = localStorage.getItem('authon_cfg_phone');
            if(localStorage.getItem('authon_cfg_pix')) document.getElementById('cfgPix').value = localStorage.getItem('authon_cfg_pix');
            if(localStorage.getItem('authon_cfg_warranty')) document.getElementById('cfgWarranty').value = localStorage.getItem('authon_cfg_warranty');
            
            addNewItem();
        };

        function showTab(tab, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            if(el) el.classList.add('active');
        }

        function saveSettingsCustom() {
            localStorage.setItem('authon_cfg_name', document.getElementById('cfgName').value);
            localStorage.setItem('authon_cfg_cnpj', document.getElementById('cfgCnpj').value);
            localStorage.setItem('authon_cfg_addr', document.getElementById('cfgAddr').value);
            localStorage.setItem('authon_cfg_phone', document.getElementById('cfgPhone').value);
            localStorage.setItem('authon_cfg_pix', document.getElementById('cfgPix').value);
            localStorage.setItem('authon_cfg_warranty', document.getElementById('cfgWarranty').value);
            alert("Dados da Empresa Salvos!");
        }

        // --- SISTEMA ---
        async function saveOperation() {
            const type = document.getElementById('opType').value;
            const client = document.getElementById('clientName').value;
            const totalStr = document.getElementById('display-total').innerText;
            const totalVal = parseFloat(totalStr.replace('.','').replace(',','.'));
            
            if(!client) return alert("Preencha o nome do cliente");

            const items = [];
            document.querySelectorAll('.service-row').forEach(r => {
                const d = r.querySelector('.desc').value;
                const v = r.querySelector('.val').value;
                const q = r.querySelector('.qty').value;
                if(d) items.push({ desc: d, val: v, qty: q });
            });

            const data = {
                id: Date.now(), type: type, status: (type==='venda'?'pendente':type),
                date: document.getElementById('date').value, time: document.getElementById('time').value,
                client, phone: document.getElementById('phone').value,
                vehicle: document.getElementById('vehicle').value, plate: document.getElementById('plate').value,
                items, total: totalVal, discount: document.getElementById('discount').value
            };

            // Salva na Nuvem (UID adicionado automaticamente)
            const docId = document.getElementById('firebaseDocId').value;
            if(docId) { await window.updateInCloud(docId, data); alert("Atualizado!"); }
            else { await window.saveToCloud(data); }

            if(type !== 'agendamento') generatePDF(data);
            else { alert("Agendado!"); resetForm(); }
        }

        function addNewItem(desc='', val='', qty=1) {
            const div = document.createElement('div'); div.className = 'service-row';
            div.innerHTML = `<div><input type="number" class="qty" value="${qty}" style="text-align:center" oninput="calcTotal()"></div><div><input type="text" class="desc" placeholder="Descrição" value="${desc}"></div><div><input type="number" class="val" placeholder="0.00" value="${val}" oninput="calcTotal()"></div><div style="text-align:center; color:#c0392b;" onclick="this.parentElement.remove();calcTotal()"><i class="fas fa-trash"></i></div>`;
            document.getElementById('services-list').appendChild(div);
        }
        
        function calcTotal() { let t = 0; document.querySelectorAll('.val').forEach(i => t += Number(i.value)); const d = document.getElementById('discount').value; document.getElementById('display-total').innerText = (t - d).toLocaleString('pt-BR',{minimumFractionDigits:2}); }

        // --- PDF DINÂMICO (LÊ DADOS DIGITADOS NA CONFIG) ---
        function generatePDF(data) {
            document.getElementById('pdf-overlay').style.display = 'block';
            
            // Pega os dados que o usuário preencheu na aba Config
            const cfgName = localStorage.getItem('authon_cfg_name') || "NOME DA SUA OFICINA";
            const cfgCnpj = localStorage.getItem('authon_cfg_cnpj') || "CNPJ NÃO INFORMADO";
            const cfgAddr = localStorage.getItem('authon_cfg_addr') || "Endereço não informado";
            const cfgPhone = localStorage.getItem('authon_cfg_phone') || "";
            
            // Monta o cabeçalho personalizado
            let headerHtml = `<h2 style="margin:0; color:#333; text-transform:uppercase;">${cfgName}</h2><p style="margin:2px 0; font-size:12px;">${cfgCnpj}<br>${cfgAddr} | ${cfgPhone}</p>`;
            
            const list = data.items.map(i => `<tr><td>${i.qty}x ${i.desc}</td><td style="text-align:right">R$ ${i.val}</td></tr>`).join('');
            
            const content = `
                <div style="padding:20px;">
                    ${headerHtml}
                    <hr style="border-top:2px solid #333; margin:10px 0;">
                    <div style="display:flex; justify-content:space-between;">
                        <h3>${data.type.toUpperCase()}</h3>
                        <span>${new Date().toLocaleDateString()}</span>
                    </div>
                    <p style="background:#f9f9f9; padding:10px; border-left:4px solid #333;">
                        <strong>Cliente:</strong> ${data.client}<br>
                        <strong>Veículo:</strong> ${data.vehicle || ''} (${data.plate || ''})
                    </p>
                    <table style="width:100%; border-collapse:collapse; margin-top:15px;">
                        <tr style="background:#eee; font-weight:bold;"><td>DESCRIÇÃO</td><td style="text-align:right">VALOR</td></tr>
                        ${list}
                    </table>
                    <h3 style="text-align:right; margin-top:20px;">Total: R$ ${data.total.toLocaleString('pt-BR',{minimumFractionDigits:2})}</h3>
                </div>`;
            
            document.getElementById('invoice-paper').innerHTML = content;
            
            const opt = { margin:0, filename:'doc.pdf', html2canvas:{scale:2}, jsPDF:{unit:'mm', format:'a4'} };
            html2pdf().set(opt).from(document.getElementById('invoice-paper')).save();
            setTimeout(() => { document.getElementById('pdf-overlay').style.display = 'none'; resetForm(); }, 3000);
        }

        // FUNÇÕES AUXILIARES
        function resetForm() { document.getElementById('clientName').value = ''; document.getElementById('services-list').innerHTML=''; addNewItem(); }
        function setOpType(t) { document.getElementById('opType').value = t; document.querySelectorAll('.op-btn').forEach(b=>b.classList.remove('active')); document.querySelector('.'+t).classList.add('active'); }
        function openModal() { document.getElementById('modal-config').style.display = 'flex'; }
    </script>

    <div id="pdf-overlay"><div id="invoice-paper"></div></div>
    <div id="modal-config" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:10px; text-align:center;">
            <h3>Alterar Logo</h3><input type="file" onchange="const r = new FileReader(); r.onload=function(e){localStorage.setItem('oficina_logo',e.target.result);alert('Salvo!');document.getElementById('modal-config').style.display='none'}; r.readAsDataURL(this.files[0])">
            <br><br><button onclick="document.getElementById('modal-config').style.display='none'">Fechar</button>
        </div>
    </div>

</body>
</html>
